<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="z_tknight.oa.persist.complex.mapper.CardDetailMapper" >


	<!-- pojo类属性和对应表的结果集映射关系 -->
	<resultMap id="BaseResultMap" type="z_tknight.oa.model.vo.TagDetail">
		<id column="tag_no" property="tagNo" jdbcType="INTEGER" />
		<result column="tag_name" property="tagName" jdbcType="VARCHAR" />
		<result column="card_no" property="cardNo" jdbcType="INTEGER" />
		<result column="board_no" property="boardNo" jdbcType="INTEGER" />
	</resultMap>
	
	<!-- 评论详情的映射关系 -->
	<resultMap id="CommentDetailResultMap" type="z_tknight.oa.model.vo.CommentDetail">
		<id column="comment_no" property="commentNo" jdbcType="INTEGER" />
		<result column="comment" property="comment" jdbcType="VARCHAR" />
		<result column="user_no" property="userNo" jdbcType="INTEGER" />
		<result column="nick_name" property="nickName" jdbcType="VARCHAR" />
		<result column="comment_time" property="commentTime" jdbcType="TIMESTAMP" />
	</resultMap>
	
	<!-- 用户表映射关系 -->
	<resultMap id="UserResultMap" type="z_tknight.oa.model.entity.TUser">
		<id column="user_no" property="userNo" jdbcType="INTEGER" />
		<result column="user_name" property="userName" jdbcType="VARCHAR" />
		<result column="password" property="password" jdbcType="VARCHAR" />
		<result column="nick_name" property="nickName" jdbcType="VARCHAR" />
		<result column="introduction" property="introduction" jdbcType="VARCHAR" />
		<result column="dept_no" property="deptNo" jdbcType="INTEGER" />
		<result column="back_up" property="backUp" jdbcType="INTEGER" />
	</resultMap>
	
	<!-- 查询卡片成员 -->
	<select id="selectCardMember" resultMap="UserResultMap">
		select tu.* from t_card_user tcu join t_user tu 
		on tcu.user_no = tu.user_no and tcu.card_no = #{cardNo};
	</select>
	
	<!-- 查询用户可以查看的所有看板空间信息和看板信息 -->
	<select id="selectTagsByCards" resultMap="BaseResultMap">
		select t.*, ct.* 
		from t_tag t join t_card_tag ct 
		on t.tag_no = ct.tag_no and t.board_no in
		<foreach collection="cardNos" item="cardNo" 
			open="(" close=")" separator=",">
			#{cardNo}
		</foreach> 
		order by field(ct.card_no,
		<foreach collection="cardNos" item="cardNo" 
			close=")" separator=",">
			#{cardNo}
		</foreach> 
	</select>
	
	<!-- 通过卡片编号查询指定卡片的评论详情 -->
	<select id="selectCommentsByCardNo" resultMap="CommentDetailResultMap">
		select tc.*, tu.nick_name from t_comment tc join t_user tu 
		on tc.card_no = #{cardNo} and tc.user_no = tu.user_no
	</select>
	
</mapper>